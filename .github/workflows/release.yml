name: Release

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate version
        id: validate
        uses: ./.github/actions/validate-version
        with:
          version: ${{ github.ref_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

  cleanup-nightly-assets:
    name: Cleanup Nightly Assets
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Delete existing nightly assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete all assets from existing nightly release
          assets=$(gh release view nightly --repo ${{ github.repository }} --json assets -q '.assets[].name' 2>/dev/null || echo "")
          if [ -n "$assets" ]; then
            echo "$assets" | while read -r asset; do
              echo "Deleting asset: $asset"
              gh release delete-asset nightly "$asset" --repo ${{ github.repository }} --yes 2>/dev/null || true
            done
            echo "Cleaned up existing nightly assets"
          else
            echo "No existing nightly assets to clean up"
          fi

  release:
    name: Build and Release (${{ matrix.settings.platform }})
    runs-on: ${{ matrix.settings.os }}
    needs: [validate-version, cleanup-nightly-assets]
    if: |
      always() &&
      (needs.validate-version.result == 'success' || needs.validate-version.result == 'skipped') &&
      (needs.cleanup-nightly-assets.result == 'success' || needs.cleanup-nightly-assets.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: ubuntu-latest
            platform: linux-x64
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            platform: macos-arm64
            target: aarch64-apple-darwin
          - os: macos-latest
            platform: macos-x64
            target: x86_64-apple-darwin
          - os: windows-latest
            platform: windows-x64
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup frontend
        uses: ./.github/actions/setup-frontend

      - name: Setup Tauri dependencies (Ubuntu)
        if: matrix.settings.os == 'ubuntu-latest'
        uses: ./.github/actions/setup-tauri-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust-tauri
        with:
          components: ''

      - name: Add Rust target
        run: rustup target add ${{ matrix.settings.target }}

      - name: Build sidecar binaries
        uses: ./.github/actions/build-sidecar
        with:
          target: ${{ matrix.settings.target }}
          profile: release

      - name: Set nightly version
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          # Set fixed version for nightly builds
          NIGHTLY_VERSION="0.0.0-nightly"

          # Update tauri.conf.json
          if command -v jq &> /dev/null; then
            jq --arg v "$NIGHTLY_VERSION" '.version = $v' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json
          else
            sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$NIGHTLY_VERSION\"/" src-tauri/tauri.conf.json
            rm -f src-tauri/tauri.conf.json.bak
          fi

          # Update Cargo.toml
          sed -i.bak "s/^version = \"[^\"]*\"/version = \"$NIGHTLY_VERSION\"/" src-tauri/Cargo.toml
          rm -f src-tauri/Cargo.toml.bak

          echo "Set version to $NIGHTLY_VERSION for nightly build"

      - name: Build and release (nightly)
        if: github.ref == 'refs/heads/main'
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: nightly
          releaseName: 'Nightly Build'
          releaseBody: |
            This is an automated nightly build from the main branch.

            **Warning:** This build may be unstable and is intended for testing purposes only.

            Commit: ${{ github.sha }}
          releaseDraft: false
          prerelease: true
          args: --target ${{ matrix.settings.target }}

      - name: Build and release (stable)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Kogu ${{ github.ref_name }}'
          generateReleaseNotes: true
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.settings.target }}

  cleanup-nightly:
    name: Cleanup Old Nightly Releases
    runs-on: ubuntu-latest
    needs: release
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Delete old nightly releases
        uses: Nats-ji/delete-old-releases@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep-count: 1
          keep-old-minor-releases: false
          remove-tags: false
