name: Release

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always
  NODE_OPTIONS: '--max-old-space-size=4096'

permissions:
  contents: write

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate version
        id: validate
        uses: ./.github/actions/validate-version
        with:
          version: ${{ github.ref_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

  cleanup-nightly:
    name: Cleanup Nightly Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Delete existing nightly release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete entire nightly release (recreated with correct commit info)
          if gh release view nightly --repo ${{ github.repository }} &>/dev/null; then
            echo "Deleting existing nightly release..."
            gh release delete nightly --repo ${{ github.repository }} --yes --cleanup-tag
            echo "Deleted nightly release"
          else
            echo "No existing nightly release"
          fi

  release:
    name: Build and Release (${{ matrix.settings.platform }})
    runs-on: ${{ matrix.settings.os }}
    needs: [validate-version, cleanup-nightly]
    if: |
      always() &&
      (needs.validate-version.result == 'success' || needs.validate-version.result == 'skipped') &&
      (needs.cleanup-nightly.result == 'success' || needs.cleanup-nightly.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: ubuntu-latest
            platform: linux-x64
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            platform: macos-arm64
            target: aarch64-apple-darwin
          - os: macos-latest
            platform: macos-x64
            target: x86_64-apple-darwin
          - os: windows-latest
            platform: windows-x64
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup frontend
        uses: ./.github/actions/setup-frontend

      - name: Setup Tauri dependencies (Ubuntu)
        if: matrix.settings.os == 'ubuntu-latest'
        uses: ./.github/actions/setup-tauri-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust-tauri
        with:
          components: ''

      - name: Add Rust target
        run: rustup target add ${{ matrix.settings.target }}

      - name: Build sidecar binaries
        uses: ./.github/actions/build-sidecar
        with:
          target: ${{ matrix.settings.target }}
          profile: release

      - name: Set nightly version
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          # Get current version and short commit hash
          CURRENT_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          NIGHTLY_VERSION="${CURRENT_VERSION}-${SHORT_SHA}"

          # Update tauri.conf.json
          jq --arg v "$NIGHTLY_VERSION" '.version = $v' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json

          # Update Cargo.toml
          sed -i.bak "s/^version = \"[^\"]*\"/version = \"$NIGHTLY_VERSION\"/" src-tauri/Cargo.toml
          rm -f src-tauri/Cargo.toml.bak

          echo "Set version to $NIGHTLY_VERSION"

      - name: Build and release (nightly)
        if: github.ref == 'refs/heads/main'
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: nightly
          releaseName: 'Nightly Build'
          releaseBody: |
            This is an automated nightly build from the main branch.

            **Warning:** This build may be unstable and is intended for testing purposes only.

            Commit: ${{ github.sha }}
          releaseDraft: false
          prerelease: true
          args: --target ${{ matrix.settings.target }}

      - name: Build and release (stable)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Kogu ${{ github.ref_name }}'
          generateReleaseNotes: true
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.settings.target }}
