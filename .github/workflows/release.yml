name: Release

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate version
        id: validate
        uses: ./.github/actions/validate-version
        with:
          version: ${{ github.ref_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

  release:
    name: Build and Release (${{ matrix.settings.os }})
    runs-on: ${{ matrix.settings.os }}
    needs: [validate-version]
    if: |
      always() &&
      (needs.validate-version.result == 'success' || needs.validate-version.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup frontend
        uses: ./.github/actions/setup-frontend

      - name: Setup Tauri dependencies (Ubuntu)
        if: matrix.settings.os == 'ubuntu-latest'
        uses: ./.github/actions/setup-tauri-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust-tauri
        with:
          components: ''

      - name: Add Rust target
        run: rustup target add ${{ matrix.settings.target }}

      - name: Build sidecar binaries (Unix)
        if: matrix.settings.os != 'windows-latest'
        working-directory: src-tauri
        run: |
          mkdir -p binaries
          # Create placeholder first (Tauri build.rs requires it)
          touch "binaries/bcrypt-worker-${{ matrix.settings.target }}"
          chmod +x "binaries/bcrypt-worker-${{ matrix.settings.target }}"
          # Build sidecar
          cargo build --bin bcrypt-worker --release --target ${{ matrix.settings.target }}
          # Replace placeholder with actual binary
          cp "target/${{ matrix.settings.target }}/release/bcrypt-worker" "binaries/bcrypt-worker-${{ matrix.settings.target }}"

      - name: Build sidecar binaries (Windows)
        if: matrix.settings.os == 'windows-latest'
        working-directory: src-tauri
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path binaries
          # Create placeholder first (Tauri build.rs requires it)
          New-Item -ItemType File -Force -Path "binaries/bcrypt-worker-${{ matrix.settings.target }}.exe"
          # Build sidecar
          cargo build --bin bcrypt-worker --release --target ${{ matrix.settings.target }}
          # Replace placeholder with actual binary
          Copy-Item "target/${{ matrix.settings.target }}/release/bcrypt-worker.exe" "binaries/bcrypt-worker-${{ matrix.settings.target }}.exe" -Force

      - name: Build and release (nightly)
        if: github.ref == 'refs/heads/main'
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: nightly
          releaseName: 'Nightly Build'
          releaseBody: |
            This is an automated nightly build from the main branch.

            **Warning:** This build may be unstable and is intended for testing purposes only.

            Commit: ${{ github.sha }}
          releaseDraft: false
          prerelease: true
          args: --target ${{ matrix.settings.target }}

      - name: Build and release (stable)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Kogu ${{ github.ref_name }}'
          generateReleaseNotes: true
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.settings.target }}

  cleanup-nightly:
    name: Cleanup Old Nightly Releases
    runs-on: ubuntu-latest
    needs: release
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Delete old nightly releases
        uses: Nats-ji/delete-old-releases@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep-count: 1
          keep-old-minor-releases: false
          remove-tags: false
